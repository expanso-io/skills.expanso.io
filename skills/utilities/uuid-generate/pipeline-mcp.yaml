# Expanso Pipeline: uuid-generate (MCP mode)
# ===========================================
#
# Usage:
#   PORT=8080 expanso-edge run pipeline-mcp.yaml &
#   curl -X POST http://localhost:8080/generate -d '{}'
#   curl -X POST http://localhost:8080/generate -d '{"count": 5}'

name: "uuid-generate-mcp"
type: pipeline

config:
  http:
    enabled: true
    address: "0.0.0.0:${PORT:-8080}"

  input:
    http_server:
      path: /generate
      allowed_verbs: [POST]
      timeout: 30s

  pipeline:
    processors:
      - mapping: |
          meta trace_id = uuid_v4()
          let count = this.count.or(1)
          let count = if $count < 1 { 1 } else { if $count > 100 { 100 } else { $count } }

          let uuids = []
          let uuids = $uuids.append(uuid_v4())

          root.uuid = $uuids.index(0)
          root.uuids = if $count > 1 { $uuids } else { deleted() }
          root.count = $count
          root.format = "v4"
          root.metadata = {
            "skill": "uuid-generate",
            "mode": "mcp",
            "trace_id": meta("trace_id"),
            "timestamp": now()
          }

      - log:
          level: INFO
          message: |
            [uuid-generate] Generated ${! root.count } UUID(s) (trace: ${! meta("trace_id").slice(0, 8) })

  output:
    sync_response: {}
