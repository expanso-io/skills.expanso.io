# Expanso Pipeline: meeting-notes (CLI mode)
# ============================================
#
# Convert meeting transcript to structured notes.
#
# Usage:
#   cat transcript.txt | expanso-edge run pipeline-cli.yaml
#
# Validates against: docs.expanso.io/schemas/pipeline.schema.json

name: meeting-notes-cli
type: pipeline

config:
  input:
    stdin:
      codec: lines
      max_buffer: 2097152  # 2MB for long transcripts

  pipeline:
    processors:
      # 1. Prepare input
      - mapping: |
          meta input_hash = content().hash("sha256").encode("hex")
          meta input_length = content().length()
          meta trace_id = uuid_v4()

          root.messages = [
            {
              "role": "system",
              "content": "You are a professional meeting notes assistant. Extract structured notes from transcripts. Always respond with valid JSON containing: summary (2-3 sentences), key_points (array of strings), action_items (array of {assignee, task, due_date}), decisions (array of strings), attendees (array of names mentioned)."
            },
            {
              "role": "user",
              "content": "Extract structured meeting notes from this transcript:\n\n" + content()
            }
          ]

      # 2. Process with LLM
      - openai_chat_completion:
          api_key: "${OPENAI_API_KEY}"
          model: gpt-4o-mini

      # 3. Parse and format output
      - mapping: |
          let raw_content = this.choices.0.message.content

          # Try to parse as JSON, fallback to wrapping
          let notes = $raw_content.parse_json().catch({
            "summary": $raw_content,
            "key_points": [],
            "action_items": [],
            "decisions": [],
            "attendees": []
          })

          root.notes = $notes
          root.metadata = {
            "skill": "meeting-notes",
            "mode": "cli",
            "model": "gpt-4o-mini",
            "input_hash": meta("input_hash"),
            "input_length": meta("input_length"),
            "action_item_count": $notes.action_items.length(),
            "trace_id": meta("trace_id"),
            "timestamp": now()
          }

      # 4. Audit log
      - log:
          level: INFO
          message: |
            [meeting-notes] Extracted ${! this.metadata.action_item_count } action items (trace: ${! meta("trace_id").slice(0, 8) })

  output:
    stdout:
      codec: json_object
