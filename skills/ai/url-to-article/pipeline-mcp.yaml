# Expanso Pipeline: url-to-article (MCP mode)
# =============================================
#
# HTTP endpoint for MCP/OpenClaw integration.
#
# Usage:
#   PORT=8080 expanso-edge run pipeline-mcp.yaml
#
#   curl -X POST http://localhost:8080/extract \
#     -H "Content-Type: application/json" \
#     -d '{"url": "https://example.com/article"}'
#
# Validates against: docs.expanso.io/schemas/pipeline.schema.json

name: url-to-article-mcp
type: pipeline

config:
  http:
    enabled: true
    address: "0.0.0.0:${PORT:-8080}"

  input:
    http_server:
      path: /extract
      allowed_verbs: [POST]
      timeout: 30s

  pipeline:
    processors:
      # 1. Parse request and validate
      - mapping: |
          let url = this.url.or("")
          root = if $url.length() == 0 {
            throw("url field is required")
          } else if !$url.has_prefix("http") {
            throw("url must start with http:// or https://")
          } else {
            ""
          }
          meta url = $url
          meta trace_id = uuid_v4()

      # 2. Fetch the URL content
      - http:
          url: "${! meta(\"url\") }"
          verb: GET
          headers:
            User-Agent: "Expanso-Edge/1.0 (Article Extractor)"
            Accept: "text/html,application/xhtml+xml"

      # 3. Extract article content
      - mapping: |
          let html = content()

          let title = $html.re_find_all("<title[^>]*>([^<]+)</title>").index(0).or(
            $html.re_find_all("<h1[^>]*>([^<]+)</h1>").index(0)
          ).or("Untitled")

          let author = $html.re_find_all("\"author\"\\s*:\\s*\"([^\"]+)\"").index(0).or(
            $html.re_find_all("name=[\"']author[\"'][^>]*content=[\"']([^\"']+)").index(0)
          ).or("Unknown")

          let date = $html.re_find_all("\"datePublished\"\\s*:\\s*\"([^\"]+)\"").index(0).or("")

          let body = $html.re_replace_all("<script[^>]*>[\\s\\S]*?</script>", "").re_replace_all("<style[^>]*>[\\s\\S]*?</style>", "").re_replace_all("<[^>]+>", " ").re_replace_all("\\s+", " ").trim().slice(0, 50000)

          root.article = {
            "url": meta("url"),
            "title": $title.re_replace_all("<[^>]+>", "").trim(),
            "author": $author,
            "date": $date,
            "body": $body,
            "word_count": $body.split(" ").length()
          }
          root.metadata = {
            "skill": "url-to-article",
            "mode": "mcp",
            "trace_id": meta("trace_id"),
            "timestamp": now()
          }

      - log:
          level: INFO
          message: |
            [url-to-article] MCP request: ${! meta("url") } (trace: ${! meta("trace_id").slice(0, 8) })

  output:
    sync_response: {}

selector:
  match_labels:
    capability: http
