# Expanso Pipeline: sql-generate (MCP mode)
# ==========================================
#
# Usage:
#   PORT=8080 expanso-edge run pipeline-mcp.yaml &
#   curl -X POST http://localhost:8080/generate \
#     -d '{"description": "Get all users who signed up last month"}'

name: "sql-generate-mcp"
type: pipeline

config:
  http:
    enabled: true
    address: "0.0.0.0:${PORT:-8080}"

  input:
    http_server:
      path: /generate
      allowed_verbs: [POST]
      timeout: 60s

  pipeline:
    processors:
      - mapping: |
          let description = this.description.or(content())
          let dialect = this.dialect.or("postgresql")
          let schema = this.schema.or("")
          meta trace_id = uuid_v4()
          meta input_hash = $description.hash("sha256").encode("hex")
          meta dialect = $dialect

          let schema_context = if $schema.length() > 0 {
            "\n\nTable schema:\n" + $schema
          } else { "" }

          root.messages = [
            {
              "role": "system",
              "content": "You are a SQL expert. Generate " + $dialect + " queries from natural language. Return JSON with: 'sql' (the query, properly formatted), 'explanation' (brief explanation). Use best practices: aliases, proper JOINs, avoid SELECT *. Only return valid SQL." + $schema_context
            },
            {
              "role": "user",
              "content": $description
            }
          ]

      - openai_chat_completion:
          api_key: "${OPENAI_API_KEY}"
          model: gpt-4o-mini

      - mapping: |
          let response = this.choices.0.message.content.parse_json().catch({
            "sql": this.choices.0.message.content,
            "explanation": ""
          })

          root.sql = $response.sql
          root.explanation = $response.explanation.or("")
          root.dialect = meta("dialect")
          root.metadata = {
            "skill": "sql-generate",
            "mode": "mcp",
            "model": "gpt-4o-mini",
            "dialect": meta("dialect"),
            "input_hash": meta("input_hash"),
            "trace_id": meta("trace_id"),
            "timestamp": now()
          }

      - log:
          level: INFO
          message: |
            [sql-generate] Generated ${! meta("dialect") } query (trace: ${! meta("trace_id").slice(0, 8) })

  output:
    sync_response: {}

selector:
  match_labels:
    capability: llm
