# Expanso Pipeline: video-generate (MCP mode)
# ============================================
#
# Generate short videos from text prompts using Replicate AI.
# HTTP server mode for MCP/OpenClaw integration.
#
# Usage:
#   REPLICATE_API_TOKEN=r8_xxx PORT=8080 expanso-edge run pipeline-mcp.yaml
#
#   curl -X POST http://localhost:8080/generate \
#     -H "Content-Type: application/json" \
#     -d '{"prompt": "A cat playing piano"}'

name: video-generate-mcp
type: pipeline

config:
  input:
    http_server:
      address: "0.0.0.0:${PORT:8080}"
      path: /generate
      allowed_verbs: [POST]
      timeout: 300s

  pipeline:
    processors:
      # 1. Validate and parse input
      - mapping: |
          meta trace_id = uuid_v4()
          meta start_time = now()

          let body = content().parse_json()
          let prompt = $body.prompt.or("")

          if $prompt == "" {
            throw("prompt field is required")
          }

          root = {
            "version": "5522017e7bc92c4b2d90cc09a65051d7ade8e26c2932444ba16ca0f7a9b5cbb2",
            "input": {
              "prompt": $prompt,
              "prompt_optimizer": true
            }
          }

      # 2. Submit to Replicate API
      - http:
          url: "https://api.replicate.com/v1/predictions"
          verb: POST
          headers:
            Authorization: "Bearer ${REPLICATE_API_TOKEN}"
            Content-Type: "application/json"

      # 3. Extract prediction ID and poll URL
      - mapping: |
          meta prediction_id = this.id
          meta poll_url = this.urls.get
          meta status = this.status
          root = this

      # 4. Poll for completion (up to 60 attempts, 3s each = 3 min max)
      - while:
          at_least_once: true
          max_loops: 60
          check: 'meta("status") == "starting" || meta("status") == "processing"'
          processors:
            - sleep:
                duration: "3s"
            - http:
                url: '${! meta("poll_url") }'
                verb: GET
                headers:
                  Authorization: "Bearer ${REPLICATE_API_TOKEN}"
            - mapping: |
                meta status = this.status
                root = this

      # 5. Format final output
      - mapping: |
          let status = this.status
          let output = this.output

          root.video_url = if $status == "succeeded" { $output.index(0).or("") } else { "" }
          root.status = $status
          root.error = if $status == "failed" { this.error } else { null }
          root.metadata = {
            "skill": "video-generate",
            "mode": "mcp",
            "model": "minimax/video-01",
            "prediction_id": meta("prediction_id"),
            "trace_id": meta("trace_id"),
            "started_at": meta("start_time"),
            "completed_at": now()
          }

      - log:
          level: INFO
          message: |
            [video-generate] Status: ${! this.status } (trace: ${! meta("trace_id").slice(0, 8) })

  output:
    sync_response:
      status: '${! if this.status == "succeeded" { 200 } else { 500 }}'
      headers:
        Content-Type: application/json
