# Expanso Pipeline: text-to-image (MCP mode)
# =============================================
#
# HTTP endpoint for image generation.
#
# Usage:
#   PORT=8080 expanso-edge run pipeline-mcp.yaml
#
#   curl -X POST http://localhost:8080/generate \
#     -H "Content-Type: application/json" \
#     -d '{"prompt": "a sunset over mountains"}'
#
# Validates against: docs.expanso.io/schemas/pipeline.schema.json

name: text-to-image-mcp
type: pipeline

config:
  http:
    enabled: true
    address: "0.0.0.0:${PORT:-8080}"

  input:
    http_server:
      path: /generate
      allowed_verbs: [POST]
      timeout: 120s

  pipeline:
    processors:
      - mapping: |
          let prompt = this.prompt.or("")
          let size = this.size.or("1024x1024")
          let quality = this.quality.or("standard")
          let style = this.style.or("vivid")

          root = if $prompt.length() == 0 {
            throw("prompt field is required")
          } else if $prompt.length() > 4000 {
            throw("prompt exceeds maximum length of 4000 characters")
          } else {
            $prompt
          }

          meta prompt = $prompt
          meta size = $size
          meta quality = $quality
          meta style = $style
          meta trace_id = uuid_v4()

      - openai_image_generation:
          api_key: "${OPENAI_API_KEY}"
          model: dall-e-3
          size: "${! meta(\"size\") }"
          quality: "${! meta(\"quality\") }"
          style: "${! meta(\"style\") }"

      - mapping: |
          root.image_url = this.data.0.url
          root.revised_prompt = this.data.0.revised_prompt
          root.metadata = {
            "skill": "text-to-image",
            "mode": "mcp",
            "model": "dall-e-3",
            "size": meta("size"),
            "quality": meta("quality"),
            "style": meta("style"),
            "original_prompt": meta("prompt"),
            "trace_id": meta("trace_id"),
            "timestamp": now()
          }

      - log:
          level: INFO
          message: |
            [text-to-image] MCP request (trace: ${! meta("trace_id").slice(0, 8) })

  output:
    sync_response: {}

selector:
  match_labels:
    capability: llm
