# Expanso Pipeline: access-gate (MCP mode)
# ==========================================
#
# HTTP server endpoint for MCP integration.
# DENY-BY-DEFAULT: throws on no policy, no match, or explicit denial.
#
# Usage:
#   ACCESS_POLICY="marketing-bot:slack-read:read" \
#     expanso-edge run pipeline-mcp.yaml
#   curl -X POST http://localhost:4195/access-gate \
#     -d '{"agent":"marketing-bot","resource":"slack-read","action":"read"}'

name: access-gate-mcp
type: pipeline

config:
  input:
    http_server:
      path: /access-gate
      allowed_verbs: [POST]

  pipeline:
    processors:
      - mapping: |
          meta trace_id = uuid_v4()

          let input = content().parse_json()
          let agent = $input.agent.or("")
          let resource = $input.resource.or("")
          let action = $input.action.or("read")

          if $agent == "" { throw("agent is required") }
          if $resource == "" { throw("resource is required") }

          meta agent = $agent
          meta resource = $resource
          meta action = $action

          # Load policy — DENY if not configured
          let policy_env = env("ACCESS_POLICY").or("")
          if $policy_env == "" {
            throw("no ACCESS_POLICY configured — deny by default")
          }

          let policy_rules = $policy_env.split(",").map_each(rule ->
            rule.split(":").map_each(p -> p.trim())
          )

          root.agent = $agent
          root.resource = $resource
          root.action = $action
          root.policy_rules = $policy_rules
          root.passthrough = $input

      - mapping: |
          let agent = this.agent
          let resource = this.resource
          let action = this.action
          let rules = this.policy_rules

          let matching_rules = $rules.filter(rule ->
            (rule.index(0) == $agent || rule.index(0) == "*") &&
            (rule.index(1) == $resource || rule.index(1) == "*") &&
            (rule.index(2).or("read") == $action || rule.index(2).or("read") == "*")
          )

          if $matching_rules.length() == 0 {
            throw("access denied for agent " + $agent + " on resource " + $resource + " action " + $action)
          }

          root.allowed = true
          root.reason = "Matched policy rule"
          root.passthrough = this.passthrough

          root.metadata = {
            "skill": "access-gate",
            "mode": "mcp",
            "agent": $agent,
            "resource": $resource,
            "allowed": true,
            "trace_id": meta("trace_id"),
            "timestamp": now()
          }

  output:
    sync_response: {}
