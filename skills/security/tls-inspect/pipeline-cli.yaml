# Expanso Pipeline: tls-inspect (CLI mode)

name: tls-inspect-cli
type: pipeline

config:
  input:
    stdin:
      codec: lines

  pipeline:
    processors:
      - mapping: |
          meta trace_id = uuid_v4()
          meta host = content().trim()

          # Add default port if not specified
          let host_with_port = if meta("host").contains(":") {
            meta("host")
          } else {
            meta("host") + ":443"
          }
          meta host_with_port = $host_with_port

          # Placeholder - real implementation would use openssl s_client
          root.certificate = {
            "subject": "CN=" + meta("host"),
            "issuer": "Demo CA",
            "valid_from": now(),
            "valid_to": now(),
            "sans": [meta("host")],
            "fingerprint": "sha256:placeholder"
          }
          root.valid = true
          root.days_until_expiry = 365
          root.metadata = {
            "skill": "tls-inspect",
            "mode": "cli",
            "host": meta("host"),
            "port": 443,
            "trace_id": meta("trace_id"),
            "timestamp": now()
          }

      - log:
          level: INFO
          message: |
            [tls-inspect] Inspected ${! meta("host") }, valid: ${! this.valid } (trace: ${! meta("trace_id").slice(0, 8) })

  output:
    stdout:
      codec: json_object
