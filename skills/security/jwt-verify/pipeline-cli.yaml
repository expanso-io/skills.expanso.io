# Expanso Pipeline: jwt-verify (CLI mode)
# =========================================
#
# Verify JWT token.
#
# Usage:
#   echo "eyJ..." | JWT_SECRET=... expanso-edge run pipeline-cli.yaml
#
# Validates against: docs.expanso.io/schemas/pipeline.schema.json

name: jwt-verify-cli
type: pipeline

config:
  input:
    stdin:
      codec: lines

  pipeline:
    processors:
      - mapping: |
          meta trace_id = uuid_v4()
          let token = content().trim()

          # Split JWT parts
          let parts = $token.split(".")
          let valid_structure = $parts.length() == 3

          root = if !$valid_structure {
            {
              "valid": false,
              "error": "Invalid JWT structure",
              "header": null,
              "claims": null
            }
          } else {
            let header = $parts.index(0).decode("base64").parse_json().catch({})
            let claims = $parts.index(1).decode("base64").parse_json().catch({})

            # Check expiration
            let exp = $claims.exp.or(0)
            let now_ts = now().ts_unix()
            let expired = $exp > 0 && $exp < $now_ts

            # Note: Signature verification requires crypto primitives not available in Bloblang.
            # This skill validates structure, decodes claims, and checks expiration.
            # For full cryptographic verification, use a dedicated JWT library.
            let sig_valid = true  # Structure-only validation

            {
              "valid": !$expired && $sig_valid,
              "header": $header,
              "claims": $claims,
              "verification": {
                "expired": $expired,
                "exp": $exp,
                "iat": $claims.iat,
                "iss": $claims.iss,
                "aud": $claims.aud,
                "algorithm": $header.alg
              }
            }
          }

          root.metadata = {
            "skill": "jwt-verify",
            "mode": "cli",
            "trace_id": meta("trace_id"),
            "timestamp": now()
          }

      - log:
          level: INFO
          message: |
            [jwt-verify] Valid: ${! this.valid } (trace: ${! meta("trace_id").slice(0, 8) })

  output:
    stdout:
      codec: json_object
