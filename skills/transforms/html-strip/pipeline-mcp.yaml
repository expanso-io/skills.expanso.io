# Expanso Pipeline: html-strip (MCP mode)
# ========================================
#
# Usage:
#   PORT=8080 expanso-edge run pipeline-mcp.yaml &
#   curl -X POST http://localhost:8080/strip -d '{"html": "<p>Hello</p>"}'

name: "html-strip-mcp"
type: pipeline

config:
  http:
    enabled: true
    address: "0.0.0.0:${PORT:-8080}"

  input:
    http_server:
      path: /strip
      allowed_verbs: [POST]
      timeout: 60s

  pipeline:
    processors:
      - mapping: |
          meta trace_id = uuid_v4()
          let html = this.html.or(content()).string()
          let original_length = $html.length()

          let text = $html.re_replace_all("(?i)<script[^>]*>.*?</script>", "")
          let text = $text.re_replace_all("(?i)<style[^>]*>.*?</style>", "")
          let text = $text.re_replace_all("<!--.*?-->", "")
          let text = $text.re_replace_all("<[^>]+>", "")
          let text = $text.re_replace_all("&nbsp;", " ")
          let text = $text.re_replace_all("&amp;", "&")
          let text = $text.re_replace_all("&lt;", "<")
          let text = $text.re_replace_all("&gt;", ">")
          let text = $text.re_replace_all("&quot;", "\"")
          let text = $text.re_replace_all("&#39;", "'")
          let text = $text.re_replace_all("\\s+", " ").trim()

          root.text = $text
          root.original_length = $original_length
          root.text_length = $text.length()
          root.reduction_percent = if $original_length > 0 {
            (($original_length - $text.length()) * 100 / $original_length).round()
          } else { 0 }
          root.metadata = {
            "skill": "html-strip",
            "mode": "mcp",
            "trace_id": meta("trace_id"),
            "timestamp": now()
          }

      - log:
          level: INFO
          message: |
            [html-strip] ${! root.original_length } -> ${! root.text_length } chars (trace: ${! meta("trace_id").slice(0, 8) })

  output:
    sync_response: {}
