name: AI Artifact Check

on:
  pull_request:
    branches: [main]

jobs:
  check:
    name: Scan for AI Artifacts
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for AI artifact files
        run: |
          echo "Scanning for AI artifact files..."
          FOUND=0

          while IFS= read -r -d '' file; do
            echo "❌ AI artifact file found: $file"
            FOUND=1
          done < <(find . \
            -not -path './.git/*' \
            \( \
              -name 'CLAUDE.md' \
              -o -name '*.claude.md' \
              -o -name '*HANDOFF*.md' \
              -o -name 'refactoring_plan.txt' \
              -o -name 'CIRCUIT_BREAKERS*.md' \
              -o -name '*_REARCHITECTURE_*.md' \
              -o -name 'phase*.claude.md' \
            \) \
            -print0)

          if [ "$FOUND" -eq 1 ]; then
            echo ""
            echo "Remove AI planning/handoff files before merging."
            exit 1
          fi

          echo "✅ No AI artifact files found"

      - name: Scan PR diff for AI language patterns
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "Scanning diff for AI language patterns..."

          DIFF=$(git diff "$BASE_SHA".."$HEAD_SHA" -- \
            '*.md' '*.mdx' '*.txt' '*.yaml' '*.yml' '*.json' \
            | grep '^+' | grep -v '^+++')

          FOUND=0

          check_pattern() {
            local pattern="$1"
            local description="$2"
            local matches
            matches=$(echo "$DIFF" | grep -in "$pattern" || true)
            if [ -n "$matches" ]; then
              echo "❌ Found AI artifact pattern — $description:"
              echo "$matches" | head -5
              FOUND=1
            fi
          }

          check_pattern "as an ai" "AI self-identification"
          check_pattern "as a large language model" "AI self-identification"
          check_pattern "i'd be happy to" "AI filler phrase"
          check_pattern "i would be happy to" "AI filler phrase"
          check_pattern "certainly!" "AI filler phrase"
          check_pattern "of course!" "AI filler phrase"
          check_pattern "generated by claude" "AI attribution"
          check_pattern "generated by chatgpt" "AI attribution"
          check_pattern "generated by gpt" "AI attribution"
          check_pattern "# TODO: " "Unresolved TODO comment"
          check_pattern "# FIXME: " "Unresolved FIXME comment"
          check_pattern "placeholder" "Placeholder content"
          check_pattern "\[Insert " "Unfilled template placeholder"
          check_pattern "\[Add " "Unfilled template placeholder"
          check_pattern "lorem ipsum" "Lorem ipsum placeholder text"

          if [ "$FOUND" -eq 1 ]; then
            echo ""
            echo "Clean up AI artifacts and placeholder content before merging."
            exit 1
          fi

          echo "✅ No AI language patterns found in diff"
