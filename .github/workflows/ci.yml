name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Skills
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint -d relaxed skills/ || true

      - name: Validate skill structure
        run: |
          echo "Checking skill directory structure..."
          ERRORS=0

          for category_dir in skills/*/; do
            for skill_dir in "$category_dir"*/; do
              if [ -d "$skill_dir" ]; then
                # Recipes use pipeline.yaml; standard skills use skill.yaml + pipeline-cli.yaml
                HAS_SKILL_YAML=0
                HAS_PIPELINE=0

                [ -f "$skill_dir/skill.yaml" ] && HAS_SKILL_YAML=1
                [ -f "$skill_dir/pipeline-cli.yaml" ] && HAS_PIPELINE=1
                [ -f "$skill_dir/pipeline-mcp.yaml" ] && HAS_PIPELINE=1
                [ -f "$skill_dir/pipeline.yaml" ] && HAS_PIPELINE=1

                if [ "$HAS_PIPELINE" -eq 0 ]; then
                  echo "❌ Missing pipeline YAML in $skill_dir"
                  ERRORS=$((ERRORS + 1))
                fi
              fi
            done
          done

          SKILL_COUNT=$(find skills -name "skill.yaml" -o -name "pipeline.yaml" | wc -l)
          echo "✅ Validated $SKILL_COUNT skills"

          if [ "$ERRORS" -gt 0 ]; then
            echo "Found $ERRORS structural errors"
            exit 1
          fi

      - name: Validate pipeline syntax (expanso-cli)
        run: |
          # Install expanso-cli if not present
          if ! command -v expanso-cli &>/dev/null; then
            echo "Installing expanso-cli..."
            curl -fsSL https://get.expanso.io/cli | bash || {
              echo "⚠️  expanso-cli not available — skipping pipeline validation"
              exit 0
            }
          fi

          echo "Validating pipeline YAML files with expanso-cli..."
          ERRORS=0
          VALIDATED=0

          for pipeline in $(find skills -name "pipeline*.yaml" -type f); do
            if expanso-cli job validate "$pipeline" --offline 2>&1; then
              VALIDATED=$((VALIDATED + 1))
            else
              echo "❌ Validation failed: $pipeline"
              ERRORS=$((ERRORS + 1))
            fi
          done

          echo "✅ Validated $VALIDATED pipeline files"
          if [ "$ERRORS" -gt 0 ]; then
            echo "Found $ERRORS pipeline validation errors"
            exit 1
          fi

      - name: Run skills audit
        run: |
          if command -v uv &>/dev/null; then
            uv run -s scripts/audit-skills.py
          elif [ -f scripts/audit-skills.py ]; then
            python3 scripts/audit-skills.py
          else
            echo "⚠️  Audit script not found — skipping"
          fi

      - name: Validate catalog
        run: |
          if [ -f catalog.json ]; then
            python3 -c 'import json; data=json.load(open("catalog.json")); print("catalog.json valid —", len(data) if isinstance(data, list) else len(data.get("skills", [])), "entries")'
          fi
          if [ -f catalog-minimal.json ]; then
            python3 -c 'import json; json.load(open("catalog-minimal.json")); print("catalog-minimal.json valid")'
          fi
