name: "image-dimensions-cli"
type: pipeline

config:
  input:
    stdin:
      codec: all
      max_buffer: 1024

  pipeline:
    processors:
      - mapping: |
          meta trace_id = uuid_v4()
          let input = content().trim()
          let parsed = $input.parse_json().catch({})

          let w = $parsed.width.or(0).number()
          let h = $parsed.height.or(0).number()

          let pixels = $w * $h
          let mp = $pixels / 1000000
          let ratio = if $h > 0 { $w / $h } else { 0 }

          # Common aspect ratios
          let ar = if ($ratio > 1.7 && $ratio < 1.8) { "16:9" } else if ($ratio > 1.3 && $ratio < 1.4) { "4:3" } else if ($ratio > 0.99 && $ratio < 1.01) { "1:1" } else if ($ratio > 1.49 && $ratio < 1.51) { "3:2" } else { $w.string() + ":" + $h.string() }

          root.width = $w
          root.height = $h
          root.pixels = $pixels
          root.megapixels = $mp
          root.aspect_ratio = $ar
          root.ratio_decimal = $ratio
          root.orientation = if $w > $h { "landscape" } else if $h > $w { "portrait" } else { "square" }
          root.metadata = {"skill": "image-dimensions", "mode": "cli", "trace_id": meta("trace_id"), "timestamp": now()}

  output:
    stdout:
      codec: json_object
