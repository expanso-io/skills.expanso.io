name: "url-parse-cli"
type: pipeline

config:
  input:
    stdin:
      codec: all
      max_buffer: 10240

  pipeline:
    processors:
      - mapping: |
          meta trace_id = uuid_v4()
          let url = content().trim()

          # Parse URL components
          let has_protocol = $url.contains("://")
          let protocol = if $has_protocol { $url.split("://").index(0) } else { "" }
          let rest = if $has_protocol { $url.split("://").index(1) } else { $url }

          # Split host and path
          let has_path = $rest.contains("/")
          let host_part = if $has_path { $rest.split("/").index(0) } else { $rest }
          let path = if $has_path { "/" + $rest.trim_prefix($host_part + "/") } else { "/" }

          # Split host and port
          let has_port = $host_part.contains(":")
          let host = if $has_port { $host_part.split(":").index(0) } else { $host_part }
          let port = if $has_port { $host_part.split(":").index(1) } else { "" }

          # Check for query string
          let has_query = $path.contains("?")
          let clean_path = if $has_query { $path.split("?").index(0) } else { $path }
          let query = if $has_query { $path.split("?").index(1) } else { "" }

          root.url = $url
          root.protocol = $protocol
          root.host = $host
          root.port = $port
          root.path = $clean_path
          root.query = $query
          root.valid = $has_protocol && $host != ""
          root.metadata = {"skill": "url-parse", "mode": "cli", "trace_id": meta("trace_id"), "timestamp": now()}

  output:
    stdout:
      codec: json_object
