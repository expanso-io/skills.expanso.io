# Expanso Pipeline: json-canonicalize (CLI mode)
# ================================================
#
# Convert JSON to canonical form.
#
# Usage:
#   echo '{"b":2,"a":1}' | expanso-edge run pipeline-cli.yaml
#   # Output: {"a":1,"b":2}
#
# Validates against: docs.expanso.io/schemas/pipeline.schema.json

name: json-canonicalize-cli
type: pipeline

config:
  input:
    stdin:
      codec: lines

  pipeline:
    processors:
      - mapping: |
          meta trace_id = uuid_v4()

          # Parse input JSON
          let parsed = content().parse_json()

          # Canonicalize: sorted keys, no extra whitespace
          # Note: Bloblang's format_json with no indent produces stable output
          let canonical = $parsed.format_json()

          # Hash the canonical form
          let hash = $canonical.hash("sha256").encode("hex")

          root.canonical = $canonical
          root.hash = $hash
          root.metadata = {
            "skill": "json-canonicalize",
            "mode": "cli",
            "input_size": content().length(),
            "canonical_size": $canonical.length(),
            "trace_id": meta("trace_id"),
            "timestamp": now()
          }

      - log:
          level: INFO
          message: |
            [json-canonicalize] Hash: ${! this.hash.slice(0, 16) }... (trace: ${! meta("trace_id").slice(0, 8) })

  output:
    stdout:
      codec: json_object
