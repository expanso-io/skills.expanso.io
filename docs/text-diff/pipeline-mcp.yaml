# Expanso Pipeline: text-diff (MCP mode)
# =======================================
#
# Usage:
#   PORT=8080 expanso-edge run pipeline-mcp.yaml &
#   curl -X POST http://localhost:8080/diff \
#     -d '{"original": "Hello World", "modified": "Hello Universe"}'

name: "text-diff-mcp"
type: pipeline

config:
  http:
    enabled: true
    address: "0.0.0.0:${PORT:-8080}"

  input:
    http_server:
      path: /diff
      allowed_verbs: [POST]
      timeout: 30s

  pipeline:
    processors:
      - mapping: |
          meta trace_id = uuid_v4()

          let original = this.original.or("")
          let modified = this.modified.or("")

          let orig_len = $original.length()
          let mod_len = $modified.length()
          let identical = $original == $modified

          let orig_words = $original.split(" ")
          let mod_words = $modified.split(" ")

          let similarity = if $identical { 1.0 } else {
            let total = ($orig_words.length() + $mod_words.length())
            if $total == 0 { 1.0 } else {
              let max_len = if $orig_len > $mod_len { $orig_len } else { $mod_len }
              let min_len = if $orig_len < $mod_len { $orig_len } else { $mod_len }
              if $max_len == 0 { 1.0 } else { $min_len / $max_len }
            }
          }

          root.identical = $identical
          root.changes = {
            "original_length": $orig_len,
            "modified_length": $mod_len,
            "length_delta": $mod_len - $orig_len,
            "original_words": $orig_words.length(),
            "modified_words": $mod_words.length()
          }
          root.similarity = $similarity
          root.hashes = {
            "original": $original.hash("sha256").encode("hex"),
            "modified": $modified.hash("sha256").encode("hex")
          }
          root.metadata = {
            "skill": "text-diff",
            "mode": "mcp",
            "trace_id": meta("trace_id"),
            "timestamp": now()
          }

      - log:
          level: INFO
          message: |
            [text-diff] Identical: ${! root.identical } (trace: ${! meta("trace_id").slice(0, 8) })

  output:
    sync_response: {}
