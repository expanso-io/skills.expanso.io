# Expanso Pipeline: cve-scan (CLI mode)
# =======================================
#
# Scan SBOM for CVE vulnerabilities.
#
# Usage:
#   cat sbom.json | expanso-edge run pipeline-cli.yaml
#
# Validates against: docs.expanso.io/schemas/pipeline.schema.json

name: cve-scan-cli
type: pipeline

config:
  input:
    stdin:
      codec: lines

  pipeline:
    processors:
      - mapping: |
          meta trace_id = uuid_v4()

          let sbom = content().parse_json()
          let components = $sbom.components.or([])

          # Placeholder: In production, would query NVD/OSV API
          # For demo, return empty vulnerabilities
          let vulnerabilities = []

          let summary = {
            "critical": 0,
            "high": 0,
            "medium": 0,
            "low": 0,
            "total": 0
          }

          root.vulnerabilities = $vulnerabilities
          root.summary = $summary
          root.scanned_packages = $components.length()
          root.metadata = {
            "skill": "cve-scan",
            "mode": "cli",
            "packages_scanned": $components.length(),
            "vulnerabilities_found": $vulnerabilities.length(),
            "trace_id": meta("trace_id"),
            "timestamp": now()
          }

      - log:
          level: INFO
          message: |
            [cve-scan] Scanned ${! this.scanned_packages } packages, found ${! this.metadata.vulnerabilities_found } vulnerabilities (trace: ${! meta("trace_id").slice(0, 8) })

  output:
    stdout:
      codec: json_object
