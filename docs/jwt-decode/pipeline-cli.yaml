name: "jwt-decode-cli"
type: pipeline

config:
  input:
    stdin:
      codec: all
      max_buffer: 10240

  pipeline:
    processors:
      - mapping: |
          meta trace_id = uuid_v4()
          let token = content().trim()
          let parts = $token.split(".")

          let header = if $parts.length() >= 1 {
            $parts.index(0).decode("base64").parse_json().catch({})
          } else { {} }

          let payload = if $parts.length() >= 2 {
            $parts.index(1).decode("base64").parse_json().catch({})
          } else { {} }

          let signature = if $parts.length() >= 3 { $parts.index(2) } else { "" }

          root.header = $header
          root.payload = $payload
          root.signature = $signature
          root.valid_format = $parts.length() == 3
          root.metadata = {"skill": "jwt-decode", "mode": "cli", "trace_id": meta("trace_id"), "timestamp": now()}

  output:
    stdout:
      codec: json_object
