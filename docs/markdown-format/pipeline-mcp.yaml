# Expanso Pipeline: markdown-format (MCP mode)
# =============================================
#
# Usage:
#   PORT=8080 expanso-edge run pipeline-mcp.yaml &
#   curl -X POST http://localhost:8080/format \
#     -d '{"text": "My Title", "format": "heading", "level": 2}'

name: "markdown-format-mcp"
type: pipeline

config:
  http:
    enabled: true
    address: "0.0.0.0:${PORT:-8080}"

  input:
    http_server:
      path: /format
      allowed_verbs: [POST]
      timeout: 30s

  pipeline:
    processors:
      - mapping: |
          meta trace_id = uuid_v4()
          let text = this.text.or(content())
          let format = this.format.or("paragraph")
          let level = this.level.or(1).number().catch(1)
          let lang = this.lang.or("")
          let url = this.url.or("#")

          let numbered = $text.split("\n").fold({"index": 1, "items": []}, pair -> {
            "index": pair.tally.index + 1,
            "items": pair.tally.items.append(pair.tally.index.string() + ". " + pair.value)
          }).items.join("\n")

          let result = match $format {
            "heading" => "#".repeat($level) + " " + $text,
            "h1" => "# " + $text,
            "h2" => "## " + $text,
            "h3" => "### " + $text,
            "bold" => "**" + $text + "**",
            "italic" => "_" + $text + "_",
            "code" => "```" + $lang + "\n" + $text + "\n```",
            "inline-code" => "`" + $text + "`",
            "quote" => "> " + $text.re_replace_all("\n", "\n> "),
            "list" => $text.split("\n").map_each(line -> "- " + line).join("\n"),
            "numbered" => $numbered,
            "link" => "[" + $text + "](" + $url + ")",
            _ => $text
          }

          root.markdown = $result
          root.format = $format
          root.original = $text
          root.metadata = {
            "skill": "markdown-format",
            "mode": "mcp",
            "format_type": $format,
            "trace_id": meta("trace_id"),
            "timestamp": now()
          }

      - log:
          level: INFO
          message: |
            [markdown-format] Applied ${! root.format } (trace: ${! meta("trace_id").slice(0, 8) })

  output:
    sync_response: {}
